<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Shopnora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #10B981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .discount-badge { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; z-index: 10; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow p-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <a href="index.html">
                <img src="https://i.postimg.cc/VNzGbSxM/20260102-184321.png" class="h-10">
            </a>
            <span class="font-bold text-green-600 text-lg hidden md:block">Shopnora</span>
        </div>
        <a href="index.html" class="text-green-600 hover:text-green-800 font-bold">
            <i class="fas fa-arrow-left mr-1"></i> সব পণ্যে ফিরে যান
        </a>
    </nav>

    <!-- Product Detail Section -->
    <div class="container mx-auto px-4 py-8">
        <div id="product-loader" class="flex flex-col items-center justify-center py-20">
            <div class="spinner mb-4"></div>
            <p class="text-gray-500">পণ্যের তথ্য লোড হচ্ছে...</p>
        </div>

        <div id="product-detail" class="hidden">
            <!-- Breadcrumb -->
            <div class="mb-6 text-sm text-gray-500">
                <a href="index.html" class="hover:text-green-600">হোম</a> / 
                <a href="index.html" class="hover:text-green-600">পণ্য</a> / 
                <span id="product-category" class="text-gray-700"></span> / 
                <span id="product-name-breadcrumb" class="font-bold text-green-600"></span>
            </div>

            <!-- Main Product Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                <!-- Product Images -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="mb-4">
                        <img id="main-product-image" src="" class="w-full h-80 object-contain rounded-lg bg-gray-100">
                    </div>
                    <div class="flex space-x-2 overflow-x-auto">
                        <!-- Additional images can be added here -->
                    </div>
                </div>

                <!-- Product Info -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h1 id="product-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-2"></h1>
                    
                    <div class="flex items-center mb-4">
                        <div class="flex text-yellow-400 mr-2">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="text-gray-600 text-sm">(45 রিভিউ)</span>
                    </div>

                    <!-- Price Section -->
                    <div class="mb-6">
                        <div class="flex items-center mb-2">
                            <span id="product-price" class="text-3xl font-bold text-green-600 mr-3"></span>
                            <span id="product-regular-price" class="text-xl text-gray-400 line-through"></span>
                            <span id="product-discount" class="ml-3 bg-red-100 text-red-600 px-2 py-1 rounded text-sm font-bold"></span>
                        </div>
                        <p class="text-gray-600">+ ডেলিভারি চার্জ</p>
                    </div>

                    <!-- Stock Status -->
                    <div class="mb-6">
                        <div class="flex items-center">
                            <span id="stock-status" class="px-3 py-1 rounded-full text-sm font-bold mr-3"></span>
                            <span id="stock-quantity" class="text-gray-600"></span>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-8">
                        <h3 class="font-bold text-lg mb-2 text-gray-700">পণ্যের বিবরণ</h3>
                        <p id="product-description" class="text-gray-600 leading-relaxed"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="flex items-center border rounded-lg">
                                <button id="decrease-qty" class="px-4 py-2 text-xl">-</button>
                                <span id="product-qty" class="px-4 py-2 border-x font-bold">1</span>
                                <button id="increase-qty" class="px-4 py-2 text-xl">+</button>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">স্টক:</p>
                                <p id="available-stock" class="font-bold"></p>
                            </div>
                        </div>

                        <button id="add-to-cart-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center">
                            <i class="fas fa-shopping-cart mr-2"></i> কার্টে যোগ করুন
                        </button>
                        <button id="buy-now-btn" class="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600">
                            এখনই কিনুন
                        </button>
                        <button id="direct-order-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">
                            <i class="fas fa-bolt mr-2"></i> সরাসরি অর্ডার করুন
                        </button>
                    </div>

                    <!-- Social Share -->
                    <div class="mt-8 pt-6 border-t">
                        <h3 class="font-bold mb-3">সোশ্যাল মিডিয়ায় শেয়ার করুন</h3>
                        <div class="flex space-x-3">
                            <button onclick="shareProduct('facebook')" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                <i class="fab fa-facebook-f mr-2"></i> Facebook
                            </button>
                            <button onclick="shareProduct('twitter')" class="flex-1 bg-blue-400 text-white py-2 rounded hover:bg-blue-500">
                                <i class="fab fa-twitter mr-2"></i> Twitter
                            </button>
                            <button onclick="shareProduct('whatsapp')" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Products Section - FIXED -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">একই ক্যাটাগরির পণ্য</h2>
                <div id="similar-products" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Similar products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Direct Order Modal -->
    <div id="direct-order-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-green-700">সরাসরি অর্ডার</h2>
            
            <!-- Login Required Message -->
            <div id="login-required" class="hidden text-center py-8">
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-700 mb-2">লগইন প্রয়োজন</h3>
                <p class="text-gray-600 mb-4">সরাসরি অর্ডার করার জন্য আপনাকে লগইন করতে হবে</p>
                <button onclick="openLoginForDirectOrder()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">লগইন করুন</button>
            </div>
            
            <!-- Order Form (Hidden until logged in) -->
            <div id="direct-order-form-container" class="hidden">
                <form id="direct-order-form" class="space-y-3">
                    <!-- User Info -->
                    <input type="text" id="do-name" placeholder="নাম" class="w-full border p-2 rounded" required>
                    <input type="tel" id="do-phone" placeholder="মোবাইল নাম্বার" class="w-full border p-2 rounded" required>
                    <input type="email" id="do-email" placeholder="ইমেইল (রশিদের জন্য)" class="w-full border p-2 rounded" required>
                    
                    <!-- Delivery Zone Selection -->
                    <div class="mb-2">
                        <label class="block text-sm font-bold text-gray-700 mb-1">ডেলিভারি এলাকা</label>
                        <select id="do-zone" class="w-full border p-2 rounded bg-white" required onchange="calculateDirectOrderTotal()">
                            <option value="">এলাকা নির্বাচন করুন</option>
                        </select>
                    </div>

                    <textarea id="do-address" placeholder="বিস্তারিত ঠিকানা (বাড়ি/রোড নং)" class="w-full border p-2 rounded" required></textarea>
                    
                    <!-- Payment Method -->
                    <div class="mt-4">
                        <p class="font-bold mb-2">পেমেন্ট মেথড:</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 border p-2 rounded cursor-pointer">
                                <input type="radio" name="do-payment" value="COD" checked onclick="toggleDirectPaymentFields()">
                                <i class="fa-solid fa-money-bill-wave text-green-600"></i> ক্যাশ অন ডেলিভারি
                            </label>
                            <label class="flex items-center gap-2 border p-2 rounded cursor-pointer">
                                <input type="radio" name="do-payment" value="Bkash" onclick="toggleDirectPaymentFields()">
                                <img src="https://freelogopng.com/images/all_img/1656234745bkash-app-logo-png.png" class="h-6"> বিকাশ (সেন্ড মানি)
                            </label>
                            <label class="flex items-center gap-2 border p-2 rounded cursor-pointer">
                                <input type="radio" name="do-payment" value="Nagad" onclick="toggleDirectPaymentFields()">
                                <img src="https://i.postimg.cc/yN45HVbM/images.jpg" class="h-6"> নগদ (সেন্ড মানি)
                            </label>
                        </div>
                        
                        <div id="do-manual-payment-info" class="hidden mt-3 p-3 bg-blue-50 rounded border border-blue-200 text-sm">
                            <p class="font-bold text-blue-800" id="do-pay-number">সেন্ড মানি করুন: Loading...</p>
                            <input type="text" id="do-trx-id" placeholder="Transaction ID (TrxID) লিখুন" class="w-full border p-2 rounded mt-2">
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="mt-4 p-3 bg-gray-50 rounded">
                        <h3 class="font-bold mb-2">অর্ডার সুমারি</h3>
                        <div class="flex justify-between text-sm mb-1">
                            <span>পণ্য:</span>
                            <span id="do-product-name">-</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>পরিমাণ:</span>
                            <span id="do-product-qty">1</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>পণ্যের মূল্য:</span>
                            <span id="do-product-price">৳0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600 mt-2">
                            <span>ডেলিভারি চার্জ:</span>
                            <span id="do-delivery">৳0</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg text-green-700 border-t pt-2">
                            <span>সর্বমোট:</span>
                            <span id="do-grand-total">৳0</span>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="document.getElementById('direct-order-modal').classList.add('hidden')" class="text-gray-500">বাতিল</button>
                        <button type="submit" id="btn-do-confirm-order" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">অর্ডার নিশ্চিত করুন</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer (Same as main page) -->
    <footer class="bg-gray-900 text-white pt-12 pb-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Company Info -->
                <div>
                    <div class="flex items-center gap-3 mb-6">
                        <img src="https://i.postimg.cc/VNzGbSxM/20260102-184321.png" class="h-12">
                        <span class="font-bold text-2xl text-green-400">Shopnora</span>
                    </div>
                    <p class="text-gray-400 mb-4">দিনাজপুরের সেরা অনলাইন শপিং প্ল্যাটফর্ম। গুণগতমানের পণ্য, দ্রুত ডেলিভারি এবং নির্ভরযোগ্য সার্ভিস।</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="text-xl font-bold mb-6 text-white">দ্রুত লিংক</h3>
                    <ul class="space-y-3">
                        <li><a href="index.html" class="text-gray-400 hover:text-green-400 transition">হোম</a></li>
                        <li><a href="index.html" class="text-gray-400 hover:text-green-400 transition">পণ্য ব্রাউজ করুন</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">আমাদের সম্পর্কে</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">যোগাযোগ করুন</a></li>
                    </ul>
                </div>

                <!-- Customer Service -->
                <div>
                    <h3 class="text-xl font-bold mb-6 text-white">গ্রাহক সেবা</h3>
                    <ul class="space-y-3">
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">সাহায্য কেন্দ্র</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">প্রাইভেসি পলিসি</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">শর্তাবলী</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">রিটার্ন পলিসি</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-green-400 transition">এফ.এ.কিউ</a></li>
                    </ul>
                </div>

                <!-- Contact & Newsletter -->
                <div>
                    <h3 class="text-xl font-bold mb-6 text-white">যোগাযোগ</h3>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-map-marker-alt text-green-400 mt-1"></i>
                            <p class="text-gray-400">কাশীডাঙ্গা বাজার, বিরল, দিনাজপুর</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-phone text-green-400"></i>
                            <p class="text-gray-400">01737-470024</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-envelope text-green-400"></i>
                            <p class="text-gray-400">support@shopnora.com</p>
                        </div>
                    </div>
                    
                    <!-- Newsletter -->
                    <div class="mt-6">
                        <h4 class="font-bold mb-3">নিউজলেটার সাবস্ক্রাইব</h4>
                        <div class="flex">
                            <input type="email" placeholder="আপনার ইমেইল" class="flex-1 px-4 py-2 rounded-l-lg text-gray-900">
                            <button class="bg-green-600 px-4 py-2 rounded-r-lg hover:bg-green-700">সাবস্ক্রাইব</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="border-t border-gray-800 mt-12 pt-8">
                <h4 class="text-center font-bold mb-4">সাপোর্টেড পেমেন্ট মেথড</h4>
                <div class="flex justify-center space-x-6 mb-6">
                    <img src="https://freelogopng.com/images/all_img/1656234745bkash-app-logo-png.png" class="h-10">
                    <img src="https://freelogopng.com/images/all_img/1679248787nagad-logo.png" class="h-10">
                    <i class="fas fa-credit-card text-4xl text-gray-400"></i>
                    <i class="fas fa-money-bill-wave text-4xl text-gray-400"></i>
                </div>
            </div>

            <!-- Copyright -->
            <div class="text-center pt-6 border-t border-gray-800">
                <p class="text-gray-500 text-sm">&copy; 2026 Shopnora. সকল অধিকার সংরক্ষিত।</p>
                <p class="text-gray-600 text-xs mt-2">ডেভেলপড বাই <span class="text-green-400">Shopnora টেক টিম</span></p>
            </div>
        </div>
    </footer>

    <script>
        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8vG1hw9CM3xx5hSK4uphBhDhFg3vOuUU",
            authDomain: "shopnora2.firebaseapp.com", // FIXED: Correct domain
            projectId: "shopnora2",
            storageBucket: "shopnora2.firebasestorage.app",
            messagingSenderId: "51821256004",
            appId: "1:51821256004:web:45f58b800c3852ba6e4b11",
            measurementId: "G-361G2NMH7Z"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // EmailJS
        (function(){ emailjs.init("a3zv_kwWYaRXOxpqO"); })();

        // --- Global Variables ---
        let currentProduct = null;
        let similarProducts = [];
        let quantity = 1;
        let settings = { merchantNumber: "01737-470024", deliveryZones: [] };

        // --- Get Product ID from URL ---
        function getProductIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // --- Load Settings ---
        function loadSettings() {
            db.collection("settings").doc("config").get().then(doc => {
                if(doc.exists) {
                    settings = { ...settings, ...doc.data() };
                }
            });
        }

        // --- Load Product Details ---
        async function loadProductDetails() {
            const productId = getProductIdFromUrl();
            if (!productId) {
                document.getElementById('product-detail').innerHTML = '<div class="text-center py-20"><h2 class="text-2xl text-red-600 mb-4">পণ্য খুঁজে পাওয়া যায়নি</h2><a href="index.html" class="text-green-600 hover:underline">সব পণ্যে ফিরে যান</a></div>';
                document.getElementById('product-detail').classList.remove('hidden');
                document.getElementById('product-loader').classList.add('hidden');
                return;
            }

            try {
                const doc = await db.collection('products').doc(productId).get();
                
                if (!doc.exists) {
                    document.getElementById('product-detail').innerHTML = '<div class="text-center py-20"><h2 class="text-2xl text-red-600 mb-4">পণ্য খুঁজে পাওয়া যায়নি</h2><a href="index.html" class="text-green-600 hover:underline">সব পণ্যে ফিরে যান</a></div>';
                    document.getElementById('product-detail').classList.remove('hidden');
                    document.getElementById('product-loader').classList.add('hidden');
                    return;
                }

                currentProduct = { id: doc.id, ...doc.data() };
                displayProductDetails();
                loadSimilarProducts(currentProduct.category, currentProduct.id);
                loadSettings();
                
            } catch (error) {
                console.error("Error loading product:", error);
                document.getElementById('product-detail').innerHTML = '<div class="text-center py-20"><h2 class="text-2xl text-red-600 mb-4">লোড করতে সমস্যা হয়েছে</h2><a href="index.html" class="text-green-600 hover:underline">সব পণ্যে ফিরে যান</a></div>';
                document.getElementById('product-detail').classList.remove('hidden');
                document.getElementById('product-loader').classList.add('hidden');
            }
        }

        // --- Display Product Details ---
        function displayProductDetails() {
            const product = currentProduct;
            
            // Update product information
            document.getElementById('product-title').textContent = product.name;
            document.getElementById('product-name-breadcrumb').textContent = product.name.substring(0, 30) + (product.name.length > 30 ? '...' : '');
            document.getElementById('product-category').textContent = product.category || 'পণ্য';
            document.getElementById('main-product-image').src = product.image;
            document.getElementById('product-price').textContent = '৳' + product.price;
            
            if (product.regularPrice && product.regularPrice > product.price) {
                document.getElementById('product-regular-price').textContent = '৳' + product.regularPrice;
                const discount = Math.round(((product.regularPrice - product.price) / product.regularPrice) * 100);
                document.getElementById('product-discount').textContent = discount + '% ছাড়';
            } else {
                document.getElementById('product-regular-price').classList.add('hidden');
                document.getElementById('product-discount').classList.add('hidden');
            }
            
            document.getElementById('product-description').textContent = product.description || 'কোনো বিবরণ নেই।';
            
            // Stock status
            const stockStatus = document.getElementById('stock-status');
            if (product.stock > 0) {
                stockStatus.textContent = 'ইন স্টক';
                stockStatus.className = 'px-3 py-1 rounded-full text-sm font-bold mr-3 bg-green-100 text-green-800';
            } else {
                stockStatus.textContent = 'স্টক আউট';
                stockStatus.className = 'px-3 py-1 rounded-full text-sm font-bold mr-3 bg-red-100 text-red-800';
            }
            
            document.getElementById('stock-quantity').textContent = product.stock > 0 ? `${product.stock} পিস প্রাপ্য` : 'স্টক নেই';
            document.getElementById('available-stock').textContent = product.stock > 0 ? `${product.stock} পিস` : 'স্টক নেই';
            
            // Enable/disable buttons based on stock
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const buyNowBtn = document.getElementById('buy-now-btn');
            const directOrderBtn = document.getElementById('direct-order-btn');
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            
            if (product.stock > 0) {
                addToCartBtn.disabled = false;
                buyNowBtn.disabled = false;
                directOrderBtn.disabled = false;
                decreaseBtn.disabled = false;
                increaseBtn.disabled = false;
                addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                buyNowBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                directOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
                directOrderBtn.disabled = true;
                decreaseBtn.disabled = true;
                increaseBtn.disabled = true;
                addToCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                buyNowBtn.classList.add('opacity-50', 'cursor-not-allowed');
                directOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Show product detail section
            document.getElementById('product-loader').classList.add('hidden');
            document.getElementById('product-detail').classList.remove('hidden');
            
            // Update page title
            document.title = `${product.name} - Shopnora`;
        }

        // --- Load Similar Products (FIXED) ---
        async function loadSimilarProducts(category, excludeId) {
            try {
                const snapshot = await db.collection('products')
                    .where('category', '==', category)
                    .limit(10)
                    .get();
                
                similarProducts = [];
                snapshot.forEach(doc => {
                    if (doc.id !== excludeId) {
                        similarProducts.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                displaySimilarProducts();
                
            } catch (error) {
                console.error("Error loading similar products:", error);
                document.getElementById('similar-products').innerHTML = '<p class="text-gray-500 text-center col-span-full py-10">সদৃশ পণ্য লোড করতে সমস্যা হয়েছে</p>';
            }
        }

        // --- Display Similar Products ---
        function displaySimilarProducts() {
            const container = document.getElementById('similar-products');
            container.innerHTML = '';
            
            if (similarProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-full py-10">এই ক্যাটাগরিতে আরও পণ্য পাওয়া যায়নি</p>';
                return;
            }
            
            // Display up to 5 similar products
            similarProducts.slice(0, 5).forEach(product => {
                const discount = product.regularPrice && product.regularPrice > product.price 
                    ? Math.round(((product.regularPrice - product.price) / product.regularPrice) * 100)
                    : 0;
                
                // Stock status
                const stockStatus = product.stock && product.stock > 0 ? '' : '<span class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded">স্টক আউট</span>';
                const opacity = product.stock && product.stock > 0 ? '' : 'opacity-60 grayscale';
                const btnState = product.stock > 0 ? `onclick="addToCartFromDetail('${product.id}', '${product.name}', ${product.price}, '${product.image}')"` : 'disabled';
                
                // Discount badge
                let discountBadge = '';
                if (discount > 0) {
                    discountBadge = `<div class="discount-badge">${discount}% OFF</div>`;
                }
                
                container.innerHTML += `
                    <div class="bg-white rounded shadow p-3 flex flex-col h-full hover:shadow-lg transition relative ${opacity}">
                        ${stockStatus}
                        ${discountBadge}
                        <div class="h-32 bg-gray-100 rounded mb-2 overflow-hidden flex items-center justify-center cursor-pointer" onclick="viewProduct('${product.id}')">
                            <img src="${product.image}" class="h-full w-full object-contain">
                        </div>
                        <h3 class="font-bold text-sm text-gray-800 line-clamp-2 cursor-pointer mb-1" onclick="viewProduct('${product.id}')">${product.name}</h3>
                        
                        <div class="mb-2" onclick="viewProduct('${product.id}')" class="cursor-pointer">
                            <span class="text-green-600 font-bold text-lg">৳${product.price}</span>
                            ${discount > 0 ? `<span class="text-xs text-gray-400 line-through ml-1">৳${product.regularPrice}</span>` : ''}
                        </div>
                        
                        <button ${btnState} onclick="event.stopPropagation(); addToCartFromDetail('${product.id}', '${product.name}', ${product.price}, '${product.image}')" 
                                class="mt-auto bg-green-600 text-white w-full py-2 rounded text-sm hover:bg-green-700 shadow">
                            <i class="fa-solid fa-cart-shopping mr-1"></i> Add to cart
                        </button>
                    </div>
                `;
            });
        }

        // --- Quantity Controls ---
        document.getElementById('increase-qty').addEventListener('click', function() {
            if (currentProduct && quantity < currentProduct.stock) {
                quantity++;
                document.getElementById('product-qty').textContent = quantity;
            }
        });

        document.getElementById('decrease-qty').addEventListener('click', function() {
            if (quantity > 1) {
                quantity--;
                document.getElementById('product-qty').textContent = quantity;
            }
        });

        // --- Add to Cart ---
        function addToCartFromDetail(productId, name, price, image) {
            const cart = JSON.parse(localStorage.getItem('shopnora_cart')) || [];
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({
                    id: productId,
                    name: name,
                    price: price,
                    image: image,
                    qty: 1
                });
            }
            
            localStorage.setItem('shopnora_cart', JSON.stringify(cart));
            
            // Show success message
            alert(`${name} কার্টে যোগ করা হয়েছে!`);
        }

        document.getElementById('add-to-cart-btn').addEventListener('click', function() {
            if (!currentProduct) return;
            
            addToCartFromDetail(
                currentProduct.id,
                currentProduct.name,
                currentProduct.price,
                currentProduct.image
            );
        });

        // --- Buy Now ---
        document.getElementById('buy-now-btn').addEventListener('click', function() {
            if (!currentProduct) return;
            
            // Add to cart first
            addToCartFromDetail(
                currentProduct.id,
                currentProduct.name,
                currentProduct.price,
                currentProduct.image
            );
            
            // Open cart on main page
            window.open('index.html#cart', '_blank');
        });

        // --- Direct Order ---
        document.getElementById('direct-order-btn').addEventListener('click', function() {
            if (!currentProduct) return;
            
            if (currentProduct.stock < quantity) {
                alert(`দুঃখিত, শুধুমাত্র ${currentProduct.stock} পিস স্টক আছে।`);
                return;
            }
            
            // Show the modal first
            document.getElementById('direct-order-modal').classList.remove('hidden');
            
            // Check if user is logged in
            auth.onAuthStateChanged(user => {
                if (!user) {
                    // Show login required message
                    document.getElementById('login-required').classList.remove('hidden');
                    document.getElementById('direct-order-form-container').classList.add('hidden');
                    return;
                }
                
                // User is logged in, show order form
                document.getElementById('login-required').classList.add('hidden');
                document.getElementById('direct-order-form-container').classList.remove('hidden');
                
                // Fill product info
                document.getElementById('do-product-name').textContent = currentProduct.name;
                document.getElementById('do-product-qty').textContent = quantity;
                document.getElementById('do-product-price').textContent = '৳' + (currentProduct.price * quantity);
                
                // Load user data
                db.collection("users").doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        document.getElementById('do-name').value = d.name || '';
                        document.getElementById('do-phone').value = d.phone || '';
                        document.getElementById('do-email').value = d.email || user.email || ''; 
                        document.getElementById('do-address').value = d.address || '';
                    }
                });
                
                // Load Delivery Zones
                const zoneSelect = document.getElementById('do-zone');
                zoneSelect.innerHTML = '<option value="">এলাকা নির্বাচন করুন</option>';
                if(settings.deliveryZones) {
                    settings.deliveryZones.forEach((z, i) => {
                        zoneSelect.innerHTML += `<option value="${i}">${z.name} (চার্জ: ৳${z.charge})</option>`;
                    });
                }
                
                calculateDirectOrderTotal();
            });
        });

        // Open login modal for direct order
        function openLoginForDirectOrder() {
            // Close current modal
            document.getElementById('direct-order-modal').classList.add('hidden');
            
            // Open main page login modal in new tab/window
            window.open('index.html#auth', '_blank');
            
            // Show message
            alert("লগইন বা রেজিস্ট্রেশন করুন, তারপর আবার সরাসরি অর্ডার অপশনে ক্লিক করুন।");
        }

        // --- Calculate Direct Order Total ---
        function calculateDirectOrderTotal() {
            const subtotal = currentProduct.price * quantity;
            const zoneIdx = document.getElementById('do-zone').value;
            let delCharge = 0;
            
            if(zoneIdx !== "") {
                delCharge = settings.deliveryZones[zoneIdx].charge;
            }

            document.getElementById('do-delivery').innerText = '৳' + delCharge;
            document.getElementById('do-grand-total').innerText = '৳' + (subtotal + delCharge);
        }

        // --- Toggle Direct Payment Fields ---
        function toggleDirectPaymentFields() {
            const method = document.querySelector('input[name="do-payment"]:checked').value;
            const manualDiv = document.getElementById('do-manual-payment-info');
            if(method === 'COD') manualDiv.classList.add('hidden');
            else {
                manualDiv.classList.remove('hidden');
                document.getElementById('do-pay-number').innerText = `${method} সেন্ড মানি করুন: ${settings.merchantNumber}`;
            }
        }

        // --- Direct Order Form Submit ---
        document.getElementById('direct-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-do-confirm-order');
            btn.disabled = true;
            btn.innerText = "অপেক্ষা করুন...";

            const name = document.getElementById('do-name').value;
            const phone = document.getElementById('do-phone').value;
            const email = document.getElementById('do-email').value;
            const address = document.getElementById('do-address').value;
            const zoneIdx = document.getElementById('do-zone').value;
            const method = document.querySelector('input[name="do-payment"]:checked').value;
            const trxId = document.getElementById('do-trx-id').value;

            if(zoneIdx === "") { 
                btn.disabled = false; 
                btn.innerText = "অর্ডার নিশ্চিত করুন"; 
                return alert("ডেলিভারি এলাকা নির্বাচন করুন"); 
            }
            if(method !== 'COD' && !trxId) { 
                btn.disabled = false; 
                btn.innerText = "অর্ডার নিশ্চিত করুন"; 
                return alert("TrxID দিন"); 
            }

            const deliveryCharge = settings.deliveryZones[zoneIdx].charge;
            const subtotal = currentProduct.price * quantity;
            const total = subtotal + deliveryCharge;
            const orderId = 'ORD-' + Math.floor(100000 + Math.random() * 900000);

            try {
                // Check current user
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("ইউজার লগইন নেই।");
                }

                // 1. Save Order to Firestore (Stock will be updated when delivered)
                // Don't update stock here, wait for admin to mark as delivered

                // 2. Create Order Item Array
                const orderItems = [{
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: currentProduct.price,
                    buyingPrice: currentProduct.buyingPrice || 0,
                    image: currentProduct.image,
                    qty: quantity
                }];

                // 3. Save Order to Firestore
                await db.collection('orders').add({
                    orderId,
                    userId: user.uid,
                    customer: { name, phone, email, address },
                    items: orderItems,
                    subtotal,
                    deliveryCharge,
                    total,
                    payment: { method, trxId: trxId || '' },
                    status: 'Pending',
                    date: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 4. Prepare Email
                if(email) {
                    const itemsHtml = `<tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${currentProduct.name}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${quantity}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">৳${subtotal}</td>
                    </tr>`;

                    const emailParams = {
                        to_name: name,
                        to_email: email,
                        order_id: orderId,
                        order_date: new Date().toLocaleDateString('bn-BD'),
                        order_items_html: itemsHtml,
                        subtotal: subtotal,
                        delivery_charge: deliveryCharge,
                        total_amount: total,
                        delivery_address: address,
                        customer_phone: phone,
                        payment_method: method
                    };

                    emailjs.send("service_g3p9jxw", "template_i20ls5b", emailParams)
                        .then(() => console.log("Direct order email sent!"))
                        .catch(err => console.error("Email failed:", err));
                }

                alert(`অর্ডার সফল! ID: ${orderId}\nআপনার ইমেইল চেক করুন।`);
                document.getElementById('direct-order-modal').classList.add('hidden');
                document.getElementById('direct-order-form').reset();
                
                // Update product stock display (won't actually change until delivered)
                await loadProductDetails();
                
            } catch (error) { 
                console.error(error);
                alert("অর্ডার ব্যর্থ হয়েছে: " + error.message); 
            }
            
            btn.disabled = false;
            btn.innerText = "অর্ডার নিশ্চিত করুন";
        });

        // --- View Product ---
        function viewProduct(productId) {
            window.open(`product-view.html?id=${productId}`, '_blank');
        }

        // --- Social Share ---
        function shareProduct(platform) {
            if (!currentProduct) return;
            
            const productName = encodeURIComponent(currentProduct.name);
            const productUrl = encodeURIComponent(window.location.href);
            const productImage = encodeURIComponent(currentProduct.image);
            
            let shareUrl = '';
            
            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${productUrl}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${productName}&url=${productUrl}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${productName}%20${productUrl}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', function() {
            loadProductDetails();
            
            // Initialize quantity controls
            document.getElementById('product-qty').textContent = quantity;
        });

        // Handle back button
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                window.close();
            }
        });
    </script>
</body>
</html>