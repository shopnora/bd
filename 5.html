.<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopnora Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .active-tab { background-color: #10B981; color: white; }
        @media print {
            body * { visibility: hidden; }
            #invoice-area, #invoice-area * { visibility: visible; }
            #invoice-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

    <!-- Login Screen -->
    <div id="admin-login" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h2>
            <input type="email" id="adm-email" placeholder="Email" class="w-full border p-2 mb-4 rounded">
            <input type="password" id="adm-pass" placeholder="Password" class="w-full border p-2 mb-6 rounded">
            <button onclick="adminLogin()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Login</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="admin-panel" class="hidden h-full flex flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col hidden md:flex">
            <div class="p-6 border-b border-gray-700 flex items-center gap-2">
                <span class="font-bold text-xl">Shopnora Admin</span>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800 active-tab"><i class="fa-solid fa-chart-line mr-2"></i> ড্যাশবোর্ড</button>
                <button onclick="switchTab('orders')" id="btn-orders" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800"><i class="fa-solid fa-box mr-2"></i> অর্ডার সমূহ</button>
                <button onclick="switchTab('products')" id="btn-products" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800"><i class="fa-solid fa-list mr-2"></i> পণ্য তালিকা</button>
                <button onclick="switchTab('add-product')" id="btn-add-product" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800"><i class="fa-solid fa-plus-circle mr-2"></i> পণ্য যোগ / এডিট</button>
                <button onclick="switchTab('categories')" id="btn-categories" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800"><i class="fa-solid fa-tags mr-2"></i> ক্যাটাগরি</button>
                <button onclick="switchTab('settings')" id="btn-settings" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-800"><i class="fa-solid fa-cog mr-2"></i> সেটিংস</button>
                <button onclick="firebase.auth().signOut()" class="w-full text-left px-4 py-3 rounded hover:bg-red-900 mt-10"><i class="fa-solid fa-sign-out mr-2"></i> লগআউট</button>
            </nav>
        </aside>

        <!-- Mobile Header -->
        <div class="md:hidden bg-gray-900 text-white p-4 flex justify-between items-center z-40 fixed w-full top-0">
            <span class="font-bold">Shopnora Admin</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('fixed'); document.querySelector('aside').classList.toggle('h-full'); document.querySelector('aside').classList.toggle('z-50');" class="text-white text-xl"><i class="fa-solid fa-bars"></i></button>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 mt-14 md:mt-0">
            
            <!-- Tab: Dashboard -->
            <div id="view-dashboard">
                <h2 class="text-2xl font-bold mb-6">বিজনেস ওভারভিউ</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded shadow border-l-4 border-yellow-500">
                        <p class="text-gray-500">পেন্ডিং অর্ডার (অ্যাকশন নিন)</p>
                        <h3 class="text-3xl font-bold text-yellow-600" id="dash-pending">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                        <p class="text-gray-500">আজকের কনফার্ম অর্ডার</p>
                        <h3 class="text-3xl font-bold text-blue-600" id="dash-orders">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-green-500">
                        <p class="text-gray-500">আজকের বিক্রি (টাকা)</p>
                        <h3 class="text-3xl font-bold text-green-600" id="dash-sales">৳0</h3>
                    </div>
                </div>

                <h2 class="text-xl font-bold mb-4 mt-8">লাভ ও স্টকের হিসাব</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-indigo-50 p-6 rounded shadow">
                        <p class="text-gray-600 font-bold">সর্বমোট বিক্রি</p>
                        <h3 class="text-2xl font-bold text-indigo-700" id="total-sales">৳0</h3>
                        <div class="mt-4 pt-4 border-t border-indigo-200">
                            <p class="text-gray-600 font-bold">সর্বমোট লাভ (আনুমানিক)</p>
                            <h3 class="text-2xl font-bold text-green-600" id="total-profit">৳0</h3>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded shadow">
                        <p class="text-gray-600 font-bold">স্টক ম্যানেজমেন্ট</p>
                        <p class="mt-2">মোট প্রোডাক্ট সংখ্যা: <span id="total-products" class="font-bold">0</span></p>
                        <p>স্টক ভ্যালু (ক্রয় মূল্য অনুযায়ী): <span id="stock-value" class="font-bold text-purple-700">৳0</span></p>
                    </div>
                </div>
            </div>

            <!-- Tab: Orders -->
            <div id="view-orders" class="hidden">
                <h2 class="text-2xl font-bold mb-4">অর্ডার ম্যানেজমেন্ট</h2>
                <div id="orders-container" class="space-y-4"></div>
            </div>

            <!-- Tab: Products List -->
            <div id="view-products" class="hidden">
                <h2 class="text-xl font-bold mb-4">সকল পণ্য</h2>
                <div class="overflow-x-auto bg-white rounded shadow">
                    <table class="min-w-full">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 text-left">ছবি</th>
                                <th class="p-3 text-left">নাম</th>
                                <th class="p-3 text-left">স্টক</th>
                                <th class="p-3 text-left">কেনা/বেচা</th>
                                <th class="p-3 text-left">অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="text-gray-700 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Add/Edit Product -->
            <div id="view-add-product" class="hidden">
                <div class="bg-white p-6 rounded shadow-md max-w-2xl mx-auto">
                    <h2 class="text-xl font-bold mb-4" id="form-title">নতুন পণ্য যোগ করুন</h2>
                    <form id="product-form" class="space-y-4">
                        <input type="hidden" id="p-id"> <!-- Hidden ID for Editing -->
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="p-name" placeholder="পণ্যের নাম" class="border p-2 rounded w-full" required>
                            <select id="p-category" class="border p-2 rounded w-full bg-white"></select>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs text-gray-500">বিক্রয় মূল্য</label>
                                <input type="number" id="p-price" placeholder="Sale Price" class="border p-2 rounded w-full" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">রেগুলার মূল্য (Show Discount)</label>
                                <input type="number" id="p-reg-price" placeholder="Reg. Price" class="border p-2 rounded w-full">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">ক্রয় মূল্য (For Profit Calc)</label>
                                <input type="number" id="p-buy-price" placeholder="Buy Price" class="border p-2 rounded w-full" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="p-stock" placeholder="স্টক সংখ্যা" class="border p-2 rounded w-full" value="10">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">পণ্যের ছবি (Edit এর সময় খালি রাখলে আগেরটি থাকবে)</label>
                                <input type="file" id="p-image" class="w-full border p-2 rounded text-sm" accept="image/*">
                            </div>
                        </div>
                        <textarea id="p-desc" placeholder="ছোট বিবরণ" class="border p-2 rounded w-full h-20"></textarea>
                        
                        <div class="flex gap-2">
                            <button type="button" onclick="resetForm()" class="w-1/3 bg-gray-500 text-white py-2 rounded font-bold">রিসেট</button>
                            <button type="submit" id="submit-btn" class="w-2/3 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">সেভ করুন</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Categories -->
            <div id="view-categories" class="hidden">
                <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
                    <h2 class="text-xl font-bold mb-4">ক্যাটাগরি ম্যানেজমেন্ট</h2>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="new-cat-name" placeholder="নতুন ক্যাটাগরি নাম" class="border p-2 flex-1 rounded">
                        <button onclick="addCategory()" class="bg-blue-600 text-white px-4 rounded">যোগ করুন</button>
                    </div>
                    <ul id="cat-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Tab: Settings -->
            <div id="view-settings" class="hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- General Settings -->
                    <div class="bg-white p-6 rounded shadow">
                        <h2 class="text-xl font-bold mb-4">সাধারণ সেটিংস</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block font-bold text-sm mb-1">মার্চেন্ট নাম্বার (বিকাশ/নগদ)</label>
                                <input type="text" id="set-phone" class="border p-2 w-full rounded">
                            </div>
                            <button onclick="saveGeneralSettings()" class="bg-green-600 text-white px-6 py-2 rounded font-bold">সেভ করুন</button>
                        </div>
                    </div>

                    <!-- Delivery Zones -->
                    <div class="bg-white p-6 rounded shadow">
                        <h2 class="text-xl font-bold mb-4">ডেলিভারি চার্জ (এলাকা ভিত্তিক)</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="zone-name" placeholder="এলাকার নাম (যেমন: দিনাজপুর সদর)" class="border p-2 flex-1 text-sm rounded">
                            <input type="number" id="zone-cost" placeholder="চার্জ" class="border p-2 w-20 text-sm rounded">
                            <button onclick="addZone()" class="bg-blue-600 text-white px-3 rounded">Add</button>
                        </div>
                        <ul id="zone-list" class="space-y-2 text-sm"></ul>
                    </div>

                    <!-- Offers Slider Manager -->
                    <div class="bg-white p-6 rounded shadow col-span-full">
                        <h3 class="font-bold text-lg mb-4">ব্যানার / স্লাইডার ম্যানেজমেন্ট</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="file" id="offer-file" class="border p-1 w-full text-sm">
                            <button onclick="uploadOffer()" id="offer-btn" class="bg-purple-600 text-white px-4 rounded text-sm">আপলোড</button>
                        </div>
                        <div id="offer-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Hidden Invoice Template -->
    <div id="invoice-area" class="hidden bg-white p-10 max-w-2xl mx-auto">
        <div class="text-center border-b pb-4 mb-4">
            <h1 class="text-3xl font-bold text-green-700">Shopnora</h1>
            <p>কাশীডাঙ্গা বাজার, বিরল, দিনাজপুর</p>
            <p>মোবাইল: 01737-470024</p>
        </div>
        <div class="flex justify-between mb-6">
            <div>
                <p class="text-sm text-gray-500">ইনভয়েস টু:</p>
                <h3 class="font-bold" id="inv-name">Customer Name</h3>
                <p id="inv-address">Address</p>
                <p id="inv-phone">Phone</p>
            </div>
            <div class="text-right">
                <p class="font-bold" id="inv-id">#ORD-123456</p>
                <p id="inv-date">Date</p>
                <span id="inv-status" class="bg-gray-200 px-2 py-1 rounded text-xs">Paid</span>
            </div>
        </div>
        <table class="w-full mb-6">
            <thead class="bg-gray-100">
                <tr>
                    <th class="text-left p-2">পণ্য</th>
                    <th class="text-center p-2">পরিমাণ</th>
                    <th class="text-right p-2">দাম</th>
                    <th class="text-right p-2">মোট</th>
                </tr>
            </thead>
            <tbody id="inv-items"></tbody>
        </table>
        <div class="flex justify-end">
            <div class="w-48 space-y-2">
                <div class="flex justify-between"><span>সাব-টোটাল:</span> <span id="inv-sub">0</span></div>
                <div class="flex justify-between"><span>ডেলিভারি:</span> <span id="inv-del">0</span></div>
                <div class="flex justify-between font-bold border-t pt-2"><span>সর্বমোট:</span> <span id="inv-total">0</span></div>
            </div>
        </div>
        <div class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
            <p>আমাদের সাথে থাকার জন্য ধন্যবাদ! আপনার দিনটি শুভ হোক।</p>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8vG1hw9CM3xx5hSK4uphBhDhFg3vOuUU",
            authDomain: "shopnora2.firebaseapp.com",
            projectId: "shopnora2",
            storageBucket: "shopnora2.firebasestorage.app",
            messagingSenderId: "51821256004",
            appId: "1:51821256004:web:45f58b800c3852ba6e4b11",
            measurementId: "G-361G2NMH7Z"
        };
        const IMGBB_API_KEY = "650aa920e240f1c7216b71dbf5114041";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let deliveryZones = [];
        let editingProductId = null;

        // --- 2. AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadSettings();
                loadDashboardStats();
            } else {
                document.getElementById('admin-login').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        function adminLogin() {
            const e = document.getElementById('adm-email').value;
            const p = document.getElementById('adm-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert("Login Failed: " + err.message));
        }

        // --- 3. NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-tab'));
            
            document.getElementById('view-' + tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId)?.classList.add('active-tab');

            if(tabId === 'add-product') resetForm();
        }

        // --- 4. DASHBOARD & STATS ---
        function loadDashboardStats() {
            // Orders Stats
            db.collection("orders").onSnapshot(snap => {
                let todaySales = 0, todayOrders = 0, pending = 0, totalSales = 0, totalProfit = 0;
                const today = new Date().toDateString();

                snap.forEach(doc => {
                    const o = doc.data();
                    const oDate = o.date ? o.date.toDate() : new Date();

                    if(o.status === 'Pending') {
                        pending++;
                    } else if (o.status !== 'Cancelled') {
                        totalSales += o.total; // Total Revenue
                        
                        // Calculate Profit for this order
                        let orderCost = 0;
                        if(o.items) {
                            o.items.forEach(item => {
                                // If buyingPrice exists in order item (new feature), use it. Else estimate.
                                const buyPrice = item.buyingPrice || (item.price * 0.8); // fallback 80% if not found
                                orderCost += (buyPrice * item.qty);
                            });
                        }
                        totalProfit += (o.subtotal - orderCost); // Profit excluding delivery charge margin

                        if(oDate.toDateString() === today) {
                            todayOrders++;
                            todaySales += o.total;
                        }
                    }
                });

                document.getElementById('dash-pending').innerText = pending;
                document.getElementById('dash-orders').innerText = todayOrders;
                document.getElementById('dash-sales').innerText = '৳' + todaySales;
                document.getElementById('total-sales').innerText = '৳' + totalSales;
                document.getElementById('total-profit').innerText = '৳' + Math.round(totalProfit);
            });

            // Stock Stats
            db.collection("products").onSnapshot(snap => {
                let count = 0, stockVal = 0;
                snap.forEach(doc => {
                    const p = doc.data();
                    count++;
                    stockVal += (p.stock * (p.buyingPrice || 0));
                });
                document.getElementById('total-products').innerText = count;
                document.getElementById('stock-value').innerText = '৳' + stockVal;
            });
        }

        // --- 5. PRODUCT MANAGEMENT (ADD / EDIT) ---
        
        // Load Categories
        db.collection("categories").onSnapshot(snap => {
            const select = document.getElementById('p-category');
            const list = document.getElementById('cat-list');
            select.innerHTML = '<option value="">ক্যাটাগরি সিলেক্ট করুন</option>';
            list.innerHTML = '';
            snap.forEach(doc => {
                const c = doc.data();
                select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                list.innerHTML += `<li class="flex justify-between border p-2 rounded"><span>${c.name}</span><button onclick="db.collection('categories').doc('${doc.id}').delete()" class="text-red-500"><i class="fa-solid fa-trash"></i></button></li>`;
            });
        });

        function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if(name) { db.collection('categories').add({ name, active: true }); document.getElementById('new-cat-name').value = ''; }
        }

        // Form Submit (Add or Update)
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "অপেক্ষা করুন...";

            const name = document.getElementById('p-name').value;
            const price = Number(document.getElementById('p-price').value);
            const regPrice = Number(document.getElementById('p-reg-price').value);
            const buyPrice = Number(document.getElementById('p-buy-price').value);
            const stock = Number(document.getElementById('p-stock').value);
            const category = document.getElementById('p-category').value;
            const desc = document.getElementById('p-desc').value;
            const file = document.getElementById('p-image').files[0];

            let imageUrl = null;
            if(file) {
                const formData = new FormData(); formData.append("image", file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                    const data = await res.json();
                    if(data.success) imageUrl = data.data.url;
                } catch(err) { console.error(err); alert("ছবি আপলোড হয়নি"); }
            }

            const productData = {
                name, price, stock, category, description: desc,
                buyingPrice: buyPrice,
                regularPrice: regPrice || price,
                discount: regPrice > price ? Math.round(((regPrice - price)/regPrice)*100) : 0,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(imageUrl) productData.image = imageUrl;

            try {
                if(editingProductId) {
                    await db.collection("products").doc(editingProductId).update(productData);
                    alert("পণ্য আপডেট হয়েছে!");
                } else {
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    if(!imageUrl) return alert("নতুন পণ্যের জন্য ছবি বাধ্যতামূলক");
                    productData.image = imageUrl; 
                    await db.collection("products").add(productData);
                    alert("পণ্য যোগ হয়েছে!");
                }
                resetForm();
                switchTab('products');
            } catch (err) { alert("সমস্যা হয়েছে: " + err.message); }
            
            btn.disabled = false; btn.innerText = "সেভ করুন";
        });

        function editProduct(id, dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingProductId = id;
            document.getElementById('form-title').innerText = "পণ্য এডিট করুন";
            document.getElementById('p-id').value = id;
            document.getElementById('p-name').value = data.name;
            document.getElementById('p-price').value = data.price;
            document.getElementById('p-reg-price').value = data.regularPrice || '';
            document.getElementById('p-buy-price').value = data.buyingPrice || '';
            document.getElementById('p-stock').value = data.stock;
            document.getElementById('p-category').value = data.category;
            document.getElementById('p-desc').value = data.description;
            document.getElementById('submit-btn').innerText = "আপডেট করুন";
            switchTab('add-product');
        }

        function resetForm() {
            document.getElementById('product-form').reset();
            editingProductId = null;
            document.getElementById('form-title').innerText = "নতুন পণ্য যোগ করুন";
            document.getElementById('submit-btn').innerText = "সেভ করুন";
        }

        // List Products
        db.collection("products").orderBy("createdAt", "desc").onSnapshot(snap => {
            const tbody = document.getElementById('product-table-body');
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const p = doc.data();
                const dataStr = encodeURIComponent(JSON.stringify(p));
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2"><img src="${p.image}" class="w-10 h-10 object-cover rounded"></td>
                        <td class="p-2 font-semibold line-clamp-1">${p.name}</td>
                        <td class="p-2">${p.stock}</td>
                        <td class="p-2 text-xs">কিনা: ${p.buyingPrice || 'N/A'}<br>বেচা: ${p.price}</td>
                        <td class="p-2 flex gap-2">
                            <button onclick="editProduct('${doc.id}', '${dataStr}')" class="text-blue-500"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteDoc('products', '${doc.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        });

        // --- 6. SETTINGS & DELIVERY ZONES ---
        function loadSettings() {
            db.collection("settings").doc("config").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('set-phone').value = d.merchantNumber || '';
                    deliveryZones = d.deliveryZones || [];
                    renderZones();
                }
            });
            // Load Offers
            db.collection("offers").onSnapshot(s => {
                const d = document.getElementById('offer-list'); d.innerHTML='';
                s.forEach(o => d.innerHTML+=`<div class="relative"><img src="${o.data().image}" class="h-24 w-full object-cover rounded"><button onclick="deleteDoc('offers','${o.id}')" class="absolute top-0 right-0 bg-red-600 text-white w-5 h-5 text-xs rounded-full">X</button></div>`);
            });
        }

        function saveGeneralSettings() {
            const merchantNumber = document.getElementById('set-phone').value;
            db.collection("settings").doc("config").set({ merchantNumber }, { merge: true }).then(()=>alert("Saved"));
        }

        function addZone() {
            const name = document.getElementById('zone-name').value;
            const charge = Number(document.getElementById('zone-cost').value);
            if(name && charge) {
                deliveryZones.push({ name, charge });
                updateZonesDb();
                document.getElementById('zone-name').value = '';
                document.getElementById('zone-cost').value = '';
            }
        }

        function removeZone(idx) {
            deliveryZones.splice(idx, 1);
            updateZonesDb();
        }

        function updateZonesDb() {
            db.collection("settings").doc("config").update({ deliveryZones });
        }

        function renderZones() {
            const list = document.getElementById('zone-list');
            list.innerHTML = '';
            deliveryZones.forEach((z, i) => {
                list.innerHTML += `
                    <li class="flex justify-between bg-gray-50 p-2 rounded">
                        <span>${z.name} - ৳${z.charge}</span>
                        <button onclick="removeZone(${i})" class="text-red-500">X</button>
                    </li>`;
            });
        }

        async function uploadOffer() {
            const file = document.getElementById('offer-file').files[0];
            if(!file) return;
            const formData = new FormData(); formData.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const d = await res.json();
                if(d.success) await db.collection("offers").add({ image: d.data.url, date: firebase.firestore.FieldValue.serverTimestamp() });
            } catch(e){}
        }

        // --- 7. ORDERS & INVOICE ---
        db.collection("orders").orderBy("date", "desc").onSnapshot(snap => {
            const container = document.getElementById('orders-container');
            container.innerHTML = '';
            snap.forEach(doc => {
                const o = doc.data();
                const oDate = o.date ? o.date.toDate().toLocaleString() : '';
                const itemsHtml = o.items.map(i => `<li>${i.name} x ${i.qty}</li>`).join('');
                
                // Store Object for Invoice Printing
                const orderJson = encodeURIComponent(JSON.stringify({...o, dateStr: oDate}));

                container.innerHTML += `
                    <div class="bg-white p-4 rounded shadow border-l-4 ${o.status === 'Pending' ? 'border-yellow-500' : 'border-gray-300'}">
                        <div class="flex justify-between mb-2">
                            <div>
                                <span class="font-bold">#${o.orderId}</span>
                                <span class="ml-2 px-2 py-1 rounded text-xs font-bold ${o.status==='Pending'?'bg-yellow-100 text-yellow-800':'bg-green-100 text-green-800'}">${o.status}</span>
                            </div>
                            <div class="space-x-1">
                                <button onclick="printInvoice('${orderJson}')" class="bg-gray-700 text-white px-2 py-1 rounded text-xs"><i class="fa-solid fa-print"></i> রশিদ</button>
                                <button onclick="updateStatus('${doc.id}', 'Confirmed')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Confirm</button>
                                <button onclick="updateStatus('${doc.id}', 'Delivered')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Deliver</button>
                                <button onclick="deleteDoc('orders', '${doc.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Delete</button>
                            </div>
                        </div>
                        <div class="text-sm">
                            <p><strong>Customer:</strong> ${o.customer.name}, ${o.customer.phone}</p>
                            <p class="text-gray-600">${o.customer.address}</p>
                            <p class="mt-1 font-bold">Total: ৳${o.total}</p>
                        </div>
                    </div>`;
            });
        });

        function printInvoice(json) {
            const o = JSON.parse(decodeURIComponent(json));
            
            document.getElementById('inv-name').innerText = o.customer.name;
            document.getElementById('inv-phone').innerText = o.customer.phone;
            document.getElementById('inv-address').innerText = o.customer.address;
            document.getElementById('inv-id').innerText = "#" + o.orderId;
            document.getElementById('inv-date').innerText = o.dateStr;
            document.getElementById('inv-status').innerText = o.payment.method;

            const tbody = document.getElementById('inv-items');
            tbody.innerHTML = '';
            o.items.forEach(i => {
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2">${i.name}</td>
                        <td class="text-center p-2">${i.qty}</td>
                        <td class="text-right p-2">৳${i.price}</td>
                        <td class="text-right p-2">৳${i.price * i.qty}</td>
                    </tr>`;
            });

            document.getElementById('inv-sub').innerText = '৳' + o.subtotal;
            document.getElementById('inv-del').innerText = '৳' + o.deliveryCharge;
            document.getElementById('inv-total').innerText = '৳' + o.total;

            window.print();
        }

        window.deleteDoc = (c, i) => confirm("মুছে ফেলতে চান?") && db.collection(c).doc(i).delete();
        window.updateStatus = (i, s) => db.collection("orders").doc(i).update({ status: s });

    </script>
</body>
</html>